<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>IBM Salesforce Context Telemetry</title>
	<link rel="icon" type="image/svg+xml" sizes="any" href="/resources/favicon.svg">
	<link rel="icon" type="image/png" sizes="32x32" href="/resources/favicon.png">
	<link href="/css/output.css" rel="stylesheet">
	<script src="https://kit.fontawesome.com/3991db92c8.js" crossorigin="anonymous"></script>
	<style>
		:root {
			/* Light mode colors - matching Laravel Log Viewer */
			--bg-primary: #ffffff;
			--bg-secondary: #fafafa;
			--bg-sidebar: #fafafa;
			--bg-table-header: #f4f4f5;
			--text-primary: #18181b;
			--text-secondary: #52525b;
			--text-muted: #a1a1aa;
			--border-color: #e4e4e7;
			--hover-bg: #f4f4f5;

			/* Level colors - matching Laravel Log Viewer */
			--level-success: #10b981;
			--level-success-bg: #ecfdf5;
			--level-success-hover: #d1fae5;
			--level-info: #0ea5e9;
			--level-info-bg: #f0f9ff;
			--level-info-hover: #e0f2fe;
			--level-warning: #f59e0b;
			--level-warning-bg: #fffbeb;
			--level-warning-hover: #fef3c7;
			--level-error: #ef4444;
			--level-error-bg: #fef2f2;
			--level-error-hover: #fee2e2;
			--level-debug: #0ea5e9;

			/* Brand color (sky) */
			--brand-500: #0ea5e9;
			--brand-600: #0284c7;
			--brand-700: #0369a1;
			--brand-800: #075985;
			--brand-900: #0c4a6e;
			--sidebar-width: 310px;
		}

		html.dark {
			/* Dark mode colors - matching Laravel Log Viewer */
			--bg-primary: #27272a;
			--bg-secondary: #18181b;
			--bg-sidebar: #27272a;
			--bg-table-header: #18181b;
			--text-primary: #e4e4e7;
			--text-secondary: #a1a1aa;
			--text-muted: #71717a;
			--border-color: #3f3f46;
			--hover-bg: #3f3f46;

			/* Dark mode level colors */
			--level-success: #10b981;
			--level-success-bg: rgba(6, 78, 59, 0.4);
			--level-success-hover: rgba(6, 78, 59, 0.75);
			--level-info: #0ea5e9;
			--level-info-bg: rgba(12, 74, 110, 0.4);
			--level-info-hover: rgba(12, 74, 110, 0.75);
			--level-warning: #fbbf24;
			--level-warning-bg: rgba(120, 53, 15, 0.4);
			--level-warning-hover: rgba(120, 53, 15, 0.75);
			--level-error: #fb7185;
			--level-error-bg: rgba(136, 19, 55, 0.4);
			--level-error-hover: rgba(136, 19, 55, 0.75);

			/* Dark mode brand */
			--brand-500: #0ea5e9;
			--brand-600: #0284c7;
			--brand-700: #0369a1;
			--brand-800: #075985;
			--brand-900: #0c4a6e;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			background: linear-gradient(45deg, #7fa7ff, #c18bff);
			min-height: 100vh;
			padding: 20px 12px;
			position: relative;
		}

		body, body * {
			font-weight: 300 !important;
		}

		body::before {
			content: '';
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background:
				radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.3) 0%, transparent 50%),
				radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
			pointer-events: none;
			z-index: 0;
		}

		html.dark {
			color-scheme: dark;
		}

		.main-container {
			position: relative;
			z-index: 10;
			margin: 0 auto;
			width: calc(100vw - 58px);
			max-width: none;
			background: #f4f4f5;
			border-radius: 16px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
			overflow: hidden;
			display: flex;
			flex-direction: column;
			height: calc(100vh - 50px);
		}

		html.dark .main-container {
			background: #27272a;
		}


		.log-viewer-title {
			font-size: 1.25rem;
			line-height: 1.75rem;
			font-weight: 600;
			color: #10b981;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: opacity 0.2s ease;
		}

		.log-viewer-title:hover {
			opacity: 0.8;
		}

		html.dark .log-viewer-title {
			color: #10b981;
		}


		.back-link {
			font-size: 0.875rem;
			line-height: 1.25rem;
			color: #52525b;
			text-decoration: none;
			margin-left: 0;
			transition: color 0.2s ease;
		}

		html.dark .back-link {
			color: #a1a1aa;
		}

		.back-link:hover {
			color: #18181b;
		}

		html.dark .back-link:hover {
			color: #e4e4e7;
		}


		.level-filters {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.level-filter-btn {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 5px 11px;
			border: 1px solid;
			border-radius: 6px;
			font-size: 0.8125rem;
			line-height: 1.25rem;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
			position: relative;
		}

		.level-filter-btn input[type="checkbox"] {
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			width: 16px;
			height: 16px;
			margin-right: 2px;
			cursor: pointer;
			background-color: white;
			border: 1px solid #d1d5db;
			border-radius: 3px;
			position: relative;
			flex-shrink: 0;
		}

		.level-filter-btn input[type="checkbox"]:checked {
			background-color: white;
			border-color: #6b7280;
		}

		.level-filter-btn input[type="checkbox"]:checked::after {
			content: '';
			position: absolute;
			left: 4px;
			top: 1px;
			width: 5px;
			height: 9px;
			border: solid #6b7280;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg);
		}

		/* Checkbox mark color matches button background when active */
		.level-filter-btn.level-debug.active input[type="checkbox"]:checked::after {
			border-color: #8e81ea;
		}

		.level-filter-btn.level-info.active input[type="checkbox"]:checked::after {
			border-color: #2195cf;
		}

		.level-filter-btn.level-warning.active input[type="checkbox"]:checked::after {
			border-color: #DB9139;
		}

		.level-filter-btn.level-error.active input[type="checkbox"]:checked::after {
			border-color: #ea6280;
		}

		.level-filter-btn.level-success.active input[type="checkbox"]:checked::after {
			border-color: #065f46;
		}

		html.dark .level-filter-btn input[type="checkbox"] {
			background-color: white;
			border-color: #9ca3af;
		}

		html.dark .level-filter-btn input[type="checkbox"]:checked {
			background-color: white;
			border-color: #6b7280;
		}

		html.dark .level-filter-btn input[type="checkbox"]:checked::after {
			border-color: #6b7280;
		}

		html.dark .level-filter-btn.level-debug.active input[type="checkbox"]:checked::after {
			border-color: #8e81ea;
		}

		html.dark .level-filter-btn.level-info.active input[type="checkbox"]:checked::after {
			border-color: #2195cf;
		}

		html.dark .level-filter-btn.level-warning.active input[type="checkbox"]:checked::after {
			border-color: #DB9139;
		}

		html.dark .level-filter-btn.level-error.active input[type="checkbox"]:checked::after {
			border-color: #ea6280;
		}

		html.dark .level-filter-btn.level-success.active input[type="checkbox"]:checked::after {
			border-color: #065f46;
		}

		.level-filter-btn.level-debug {
			background: #f0f9ff;
			border-color: #dbeafe;
			color: #0c4a6e;
		}

		html.dark .level-filter-btn.level-debug {
			background: rgba(12, 74, 110, 0.25);
			border-color: #075985;
			color: #7dd3fc;
		}

		.level-filter-btn.level-info {
			background: #f0f9ff;
			border-color: #dbeafe;
			color: #0c4a6e;
		}

		html.dark .level-filter-btn.level-info {
			background: rgba(12, 74, 110, 0.25);
			border-color: #075985;
			color: #7dd3fc;
		}

		.level-filter-btn.level-warning {
			background: #fffbeb;
			border-color: #fef3c7;
			color: #92400e;
		}

		html.dark .level-filter-btn.level-warning {
			background: rgba(120, 53, 15, 0.25);
			border-color: #92400e;
			color: #fbbf24;
		}

		.level-filter-btn.level-error {
			background: #fef2f2;
			border-color: #fee2e2;
			color: #991b1b;
		}

		html.dark .level-filter-btn.level-error {
			background: rgba(136, 19, 55, 0.25);
			border-color: #9f1239;
			color: #fb7185;
		}

		.level-filter-btn.level-success {
			background: #d1fae5;
			border-color: #a7f3d0;
			color: #065f46;
		}

		html.dark .level-filter-btn.level-success {
			background: rgba(6, 78, 59, 0.3);
			border-color: #065f46;
			color: #10b981;
		}

		.level-filter-btn:hover {
			opacity: 1;
		}

		.level-filter-btn.level-debug:hover {
			background: #e9d5ff;
		}

		.level-filter-btn.level-info:hover {
			background: var(--level-info-hover);
		}

		.level-filter-btn.level-warning:hover {
			background: var(--level-warning-hover);
		}

		.level-filter-btn.level-error:hover {
			background: var(--level-error-hover);
		}

		.level-filter-btn.level-success:hover {
			background: var(--level-success-hover);
		}

		.level-filter-btn.active {
			color: white;
		}

		.level-filter-btn.level-debug.active {
			background: #8e81ea;
			border-color: #8e81ea;
			color: white;
		}

		.level-filter-btn.level-info.active {
			background: #2195cf;
			border-color: #2195cf;
			color: white;
		}

		html.dark .level-filter-btn.level-debug.active {
			background: #8e81ea;
			border-color: #8e81ea;
			color: white;
		}

		html.dark .level-filter-btn.level-info.active {
			background: #2195cf;
			border-color: #2195cf;
			color: white;
		}

		.level-filter-btn.level-warning.active {
			background: #DB9139;
			border-color: #DB9139;
			color: white;
		}

		html.dark .level-filter-btn.level-warning.active {
			background: #DB9139;
			border-color: #DB9139;
			color: white;
		}

		.level-filter-btn.level-error.active {
			background: #ea6280;
			border-color: #ea6280;
			color: white;
		}

		html.dark .level-filter-btn.level-error.active {
			background: #ea6280;
			border-color: #ea6280;
			color: white;
		}

		.level-filter-btn.level-success.active {
			background: #a7f3d0;
			border-color: #6ee7b7;
			color: #065f46;
		}

		html.dark .level-filter-btn.level-success.active {
			background: #a7f3d0;
			border-color: #6ee7b7;
			color: #065f46;
		}

		.level-filter-btn .level-icon {
			font-size: 0.875rem;
			line-height: 1.25rem;
		}

		.level-filter-btn .level-count {
			background: rgba(0, 0, 0, 0.08);
			padding: 1px 5px;
			border-radius: 10px;
			font-size: 0.6875rem;
			line-height: 1rem;
			font-weight: 600;
			margin-left: 2px;
			transition: background-color 0.2s ease, transform 0.2s ease;
		}

		html.dark .level-filter-btn .level-count {
			background: rgba(255, 255, 255, 0.15);
		}

		.level-filter-btn.active .level-count {
			background: rgba(255, 255, 255, 0.3);
		}

		html.dark .level-filter-btn.active .level-count {
			background: rgba(255, 255, 255, 0.3);
		}

		.level-filter-btn:hover .level-count {
			transform: scale(1.05);
		}

		.search-controls {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.table-controls {
			padding: 0 16px;
			display: flex;
			justify-content: flex-end;
			align-items: center;
			flex-shrink: 0;
		}

		.table-controls-right {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.search-input {
			padding: 6px 12px;
			border: 1px solid #d4d4d8;
			border-radius: 6px;
			font-size: 0.875rem;
			line-height: 1.25rem;
			width: 250px;
			background: white;
			color: #18181b;
			transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
		}

		html.dark .search-input {
			border-color: #52525b;
			background: #27272a;
			color: #f4f4f5;
		}

		.search-input::placeholder {
			color: #a1a1aa;
		}

		html.dark .search-input::placeholder {
			color: #71717a;
		}

		.search-input:focus {
			outline: none;
			border-color: #0ea5e9;
			box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
		}

		html.dark .search-input:focus {
			border-color: #0369a1;
			box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.3);
		}

		.control-select {
			padding: 6px 24px 6px 8px;
			border: none;
			border-radius: 0;
			font-size: 0.875rem;
			line-height: 1.25rem;
			background: transparent;
			color: #a1a1aa;
			cursor: pointer;
			transition: color 0.2s ease, opacity 0.2s ease;
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23a1a1aa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 4px center;
			background-size: 16px;
			padding-right: 24px;
		}

		.control-select:hover {
			opacity: 0.8;
		}

		.control-select:focus {
			outline: none;
			opacity: 1;
		}

		html.dark .control-select {
			color: #71717a;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2371717a' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
		}

		.control-select:hover {
			color: #52525b;
		}

		html.dark .control-select:hover {
			color: #a1a1aa;
		}

		.control-select:focus {
			outline: none;
			color: #52525b;
		}

		html.dark .control-select:focus {
			color: #a1a1aa;
		}

		.icon-btn {
			width: 40px;
			height: 40px;
			border: none;
			border-radius: 8px;
			background: #f4f4f5;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.125rem;
			line-height: 1.75rem;
			transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
			color: #a1a1aa;
		}

		.icon-btn:hover {
			transform: scale(1.1);
		}

		.icon-btn:active {
			transform: scale(0.95);
		}

		.icon-btn.notification-toggle.active {
			background: var(--brand-600);
			color: white;
		}

		html.dark .icon-btn.notification-toggle.active {
			background: var(--brand-700);
			color: white;
		}

		html.dark .icon-btn {
			background: #3f3f46;
			color: #71717a;
		}

		.icon-btn:hover {
			background: #e4e4e7;
			color: #52525b;
		}

		html.dark .icon-btn:hover {
			background: #52525b;
			color: #a1a1aa;
		}

		.delete-all-btn:hover {
			background: #fee2e2;
			color: #dc2626;
			transform: scale(1.1) rotate(5deg);
		}

		html.dark .delete-all-btn:hover {
			background: rgba(220, 38, 38, 0.2);
			color: #c64545;
		}

		.global-error-banner {
			display: none;
			margin: 10px 14px 0;
			padding: 10px 14px;
			border-radius: 10px;
			background: #fee2e2;
			border: 1px solid #fecaca;
			color: #7f1d1d;
			font-size: 0.875rem;
			font-weight: 600;
			box-shadow: 0 10px 30px rgba(190, 18, 60, 0.08);
			line-height: 1.4;
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		html.dark .global-error-banner {
			background: rgba(127, 29, 29, 0.3);
			border-color: rgba(248, 113, 113, 0.4);
			color: #fecaca;
		}

		.global-error-banner.hidden {
			display: none;
		}

		.content-wrapper {
			display: flex;
			flex: 1;
			overflow: hidden;
			gap: 0;
			padding: 0 16px;
		}

		html.dark .content-wrapper {
			background: #19181a;
		}

		.sidebar {
			width: var(--sidebar-width);
			background: transparent;
			border-right: none;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			flex-shrink: 0;
			align-items: stretch;
		}

		html.dark .sidebar {
			background: #19181a;
		}

		.sidebar-resizer {
			width: 10px;
			cursor: col-resize;
			position: relative;
			z-index: 10;
			margin: 0 6px;
		}

		.sidebar-resizer::after {
			content: '';
			position: absolute;
			top: 24px;
			bottom: 24px;
			left: 50%;
			transform: translateX(-50%);
			width: 3px;
			background: transparent;
			border-radius: 999px;
			transition: background 0.15s ease;
		}

		.sidebar-resizer:hover::after,
		.sidebar-resizer:focus-visible::after,
		body.sidebar-resizing .sidebar-resizer::after {
			background: rgba(14, 165, 233, 0.6);
		}

		body.sidebar-resizing,
		body.sidebar-resizing * {
			user-select: none !important;
			cursor: col-resize !important;
		}

		.sidebar-header {
			padding: 20px 12px;
			border-bottom: none;
			flex-shrink: 0;
		}

		@media (min-width: 768px) {
			.sidebar-header {
				padding: 20px;
			}
		}

		.sidebar-content {
			flex: 1;
			overflow-y: auto;
			padding: 0 12px 20px 12px;
			padding-top: 20px;
		}

		@media (min-width: 768px) {
			.sidebar-content {
				padding: 0 20px 20px 20px;
				padding-top: 20px;
			}
		}


		.sidebar-title {
			font-size: 0.75rem;
			line-height: 1rem;
			font-weight: 600;
			color: #52525b;
			margin-bottom: 12px;
			margin-top: 0;
			padding-top: 0;
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}

		html.dark .sidebar-title {
			color: #a1a1aa;
		}

		.server-list {
			list-style: none;
		}

		.server-item {
			padding: 10px 12px;
			margin-bottom: 6px;
			border-radius: 6px;
			cursor: pointer;
			transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: white;
			border: 2px solid transparent;
			position: relative;
			min-height: 48px;
		}

		.server-item:hover .server-item-actions {
			z-index: 1001;
		}

		.server-item:hover {
			transform: translateX(2px);
		}

		.server-item:active {
			transform: translateX(0);
		}

		html.dark .server-item {
			background: #27272c;
		}

		.server-item:hover {
			background: #e0f2fe;
			border-color: #0284c7;
		}

		html.dark .server-item:hover {
			background: #27272c;
			border-color: #0369a1;
			box-shadow: inset 0 0 0 1px rgba(14, 165, 233, 0.2);
		}

		.server-item.active {
			background: #bae6fd;
			border-color: transparent;
		}

		html.dark .server-item.active {
			background: rgba(14, 165, 233, 0.18);
			border-color: transparent;
		}

		.server-item.active .server-name {
			color: #18181b;
			font-weight: 600;
		}

		html.dark .server-item.active .server-name {
			color: #e4e4e7;
		}

		.server-name {
			font-size: 0.8125rem;
			line-height: 1.15rem;
			color: #18181b;
			flex: 1;
			font-weight: 500;
			transition: color 0.2s ease, font-weight 0.2s ease;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		html.dark .server-name {
			color: #e4e4e7;
		}

		.session-date {
			font-weight: 400 !important;
			color: inherit;
		}

		.session-user {
			font-weight: 300 !important;
			color: rgba(24, 24, 27, 0.75);
		}

		html.dark .session-user {
			color: rgba(228, 228, 231, 0.7);
		}

		.server-item.active .server-name {
			font-weight: 600;
		}

		.server-size {
			font-size: 0.75rem;
			line-height: 1rem;
			color: #52525b;
			margin-left: 8px;
		}

		html.dark .server-size {
			color: #a1a1aa;
		}

		.server-item-actions {
			position: relative;
			margin-left: auto;
			z-index: 10;
			display: flex;
			align-items: center;
			justify-content: flex-end;
			min-width: 48px;
		}

		.server-item-actions .actions-dropdown {
			z-index: 1000;
		}

		.server-item .server-item-actions .actions-dropdown.show {
			z-index: 10000;
		}

		.server-item.dropdown-open {
			z-index: 100;
		}

		.session-active-indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background-color: #10b981;
			margin-right: 8px;
			flex-shrink: 0;
		}

		html.dark .session-active-indicator {
			background-color: #10b981;
		}

		.main-content {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			background: #f4f4f5;
			position: relative;
			min-width: 0;
		}

		html.dark .main-content {
			background: #19181a;
		}

		.main-content-header {
			padding: 20px 16px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 16px;
			border-bottom: none;
			flex-shrink: 0;
		}

		.main-content-body {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			min-height: 0;
		}

		.session-activity-card {
			background: var(--bg-secondary);
			border: 1px solid var(--border-color);
			border-radius: 14px;
			padding: 16px 20px 12px 20px;
			margin: 0 16px 12px 16px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
			transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
		}

		.session-activity-card.hidden {
			display: none;
		}

		.session-activity-header {
			display: flex;
			align-items: flex-start;
			justify-content: space-between;
			gap: 16px;
			margin-bottom: 10px;
		}

		.session-activity-header .label {
			font-size: 0.75rem;
			letter-spacing: 0.08em;
			text-transform: uppercase;
			color: var(--text-muted);
			margin-bottom: 4px;
			font-weight: 600;
		}

		.session-activity-header .subtitle {
			font-size: 0.95rem;
			color: var(--text-primary);
			font-weight: 500;
		}

		.session-activity-legend {
			display: flex;
			gap: 14px;
			flex-wrap: wrap;
			align-items: center;
			font-size: 0.8rem;
			color: var(--text-secondary);
		}

		.session-activity-legend .legend-item {
			display: inline-flex;
			align-items: center;
			gap: 6px;
		}

		.session-activity-legend .legend-dot {
			width: 10px;
			height: 10px;
			border-radius: 999px;
			display: inline-block;
		}

		#sessionActivityChart {
			width: 100%;
			height: 170px;
		}

		.logs-table-container {
			flex: 1;
			overflow: hidden;
			position: relative;
			min-height: 0;
			display: flex;
			flex-direction: column;
		}

		.logs-table-container > div:last-child {
			flex: 1;
			overflow-y: auto;
			min-height: 0;
		}

		.logs-table {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0;
			font-size: 0.875rem;
			line-height: 1.25rem;
			border: none;
			border-radius: 0;
			overflow: visible;
		}

		.logs-table thead {
			display: table-header-group;
			position: sticky;
			top: 0;
			z-index: 10;
			background: #f4f4f5;
		}

		html.dark .logs-table thead {
			background: #19181a;
		}

		.logs-table tbody {
			display: table-row-group;
		}

		.logs-table th {
			padding: 12px 4px;
			text-align: left;
			font-weight: 700;
			color: #52525b;
			border-bottom: 2px solid #f4f4f5;
			font-size: 0.84375rem;
			line-height: 1;
			letter-spacing: 0.05em;
		}

		html.dark .logs-table th {
			color: #a1a1aa;
			border-bottom: 2px solid #19181a;
		}

		.logs-table td {
			padding: 8px 4px;
			border-bottom: 2px solid #f4f4f5;
			color: #18181b;
			font-size: 0.75rem;
			line-height: 1.2;
			transition: background-color 0.15s ease;
		}

		html.dark .logs-table td {
			border-bottom: 2px solid #19181a;
		}

		.logs-table tbody tr {
			transition: background-color 0.15s ease;
			background: white;
			cursor: pointer;
		}

		html.dark .logs-table tbody tr {
			background: #1f1f23;
		}

		.logs-table tbody tr:hover {
			background-color: rgba(14, 165, 233, 0.05);
		}

		html.dark .logs-table tbody tr:hover {
			background-color: rgba(14, 165, 233, 0.15);
			box-shadow: none;
		}
		/* Level-specific row hover colors */
		.logs-table tbody tr.log-item-success:hover {
			background-color: rgba(16, 185, 129, 0.05);
		}

		html.dark .logs-table tbody tr.log-item-success:hover {
			background-color: rgba(16, 185, 129, 0.2);
			box-shadow: none;
		}

		.logs-table tbody tr.log-item-info:hover {
			background-color: rgba(14, 165, 233, 0.05);
		}

		html.dark .logs-table tbody tr.log-item-info:hover {
			background-color: rgba(14, 165, 233, 0.2);
			box-shadow: none;
		}

		.logs-table tbody tr.log-item-warning:hover {
			background-color: rgba(245, 158, 11, 0.05);
		}

		html.dark .logs-table tbody tr.log-item-warning:hover {
			background-color: rgba(245, 158, 11, 0.2);
			box-shadow: none;
		}

		.logs-table tbody tr.log-item-error:hover {
			background-color: rgba(239, 68, 68, 0.05);
		}

		html.dark .logs-table tbody tr.log-item-error:hover {
			background-color: rgba(239, 68, 68, 0.2);
			box-shadow: none;
		}

		.level-badge {
			display: inline-flex;
			align-items: center;
			justify-content: flex-start;
			gap: 6px;
			padding: 4px 10px;
			border-radius: 6px;
			transition: opacity 0.2s ease, transform 0.15s ease;
			font-size: 0.64375rem;
			line-height: 1rem;
			font-weight: 800;
			text-transform: uppercase;
			width: auto;
			box-sizing: border-box;
		}

		.level-badge.debug {
			background: #8e81ea;
			color: white;
		}

		.level-badge.info {
			background: #2195cf;
			color: white;
		}

		.level-badge.warning {
			background: #DB9139;
			color: white;
		}

		.level-badge.error {
			background: #ea6280;
			color: white;
		}

		.level-badge.success {
			background: #a7f3d0;
			color: #065f46;
		}

		.level-badge-icon {
			font-size: 0.75rem;
			line-height: 1rem;
		}

		.logs-table th.time-column,
		.log-time {
			font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			color: #18181b;
			font-weight: 400 !important;
			min-width: 38px;
		}

		html.dark .logs-table th.time-column,
		html.dark .log-time {
			color: #e4e4e7;
		}

		.log-description {
			font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
			font-size: 0.6875rem;
			line-height: 1.4;
			max-width: 800px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			color: #71717a;
			padding: 4px 0;
		}

		html.dark .log-description {
			color: #a1a1aa;
		}

		.expand-btn {
			background: transparent;
			border: none;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			color: #a1a1aa;
			font-size: 0.75rem;
			transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}

		.expand-btn i {
			transition: transform 0.1s ease;
		}

		.expand-btn.expanded i {
			transform: rotate(90deg);
		}

		.expand-btn:hover {
			background: var(--hover-bg);
			color: var(--text-primary);
			transform: scale(1.1);
		}

		html.dark .expand-btn {
			color: #71717a;
		}

		html.dark .expand-btn:hover {
			color: #e4e4e7;
		}

		.log-item-expanded {
			background: var(--bg-secondary) !important;
			display: table-row;
			transform: scaleY(0);
			transform-origin: top;
			height: 0;
			overflow: hidden;
			transition: transform 0.26s ease-out, height 0.26s ease-out;
		}

		.log-item-expanded.expanded {
			transform: scaleY(1);
			height: auto;
			transition: transform 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), height 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		}

		html.dark .log-item-expanded {
			background: #18181b !important;
		}

		.log-item-expanded td {
			padding: 0 !important;
			border: none !important;
		}

		.log-item-expanded.expanded .log-description-expanded {
			padding: 12px 16px !important;
			font-size: 0.75rem !important;
		}

		.log-description-expanded {
			padding: 0 !important;
			border-top: 1px solid transparent;
			max-height: 0;
			overflow: hidden;
			opacity: 0;
			transition: max-height 0.26s ease-out, opacity 0.2s ease-out, padding 0.26s ease-out, border-color 0.2s ease-out, font-size 0.26s ease-out;
		}

		.log-item-expanded.expanded .log-description-expanded {
			max-height: 5000px;
			opacity: 1;
			padding: 12px 16px !important;
			border-top-color: var(--border-color);
			transition: max-height 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), padding 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), border-color 0.2s ease-in, font-size 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		}

		.log-item-expanded .json-pretty {
			margin: 0;
			padding: 0;
			height: 0;
			line-height: 0;
			font-size: 0;
			opacity: 0;
			overflow: hidden;
			transition: height 0.26s ease-out, line-height 0.26s ease-out, font-size 0.26s ease-out, padding 0.26s ease-out, opacity 0.2s ease-out;
		}

		.log-item-expanded.expanded .json-pretty {
			height: auto;
			line-height: 1.6;
			font-size: 0.75rem;
			opacity: 1;
			padding: 0;
			transition: height 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), line-height 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), font-size 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), padding 0.34s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		}

		.json-pretty {
			font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
			line-height: 1.6;
			color: var(--text-primary);
			margin: 0;
			padding: 0;
			white-space: pre-wrap;
			word-break: break-word;
			overflow-x: auto;
		}

		html.dark .json-pretty {
			color: #e4e4e7;
		}

		.status-indicator {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 22px;
			height: 22px;
			border-radius: 50%;
			flex-shrink: 0;
			font-size: 0.6rem;
			font-weight: 700;
			text-transform: uppercase;
			color: white;
			box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.15);
		}

		.status-indicator.ok {
			background-color: #10b981;
		}

		html.dark .status-indicator.ok {
			background-color: #007a52;
		}

		.status-indicator.ko {
			background-color: #dc2626;
		}

		html.dark .status-indicator.ko {
			background-color: #c64545;
		}

		.pagination {
			padding: 20px 32px;
			border-top: none;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			background: transparent;
		}

		html.dark .pagination {
			background: transparent;
		}

		.pagination-btn {
			padding: 8px 16px;
			border: 2px solid transparent;
			border-top: 2px solid transparent;
			border-radius: 0;
			background: transparent;
			color: #52525b;
			cursor: pointer;
			font-size: 0.875rem;
			line-height: 1.25rem;
			font-weight: 500;
			transition: color 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
			display: inline-flex;
			align-items: center;
		}

		.pagination-btn:hover:not(:disabled) {
			transform: translateY(-1px);
		}

		.pagination-btn:active:not(:disabled) {
			transform: translateY(0);
		}

		html.dark .pagination-btn {
			color: #a1a1aa;
		}

		.pagination-btn:hover:not(:disabled) {
			color: #18181b;
			border-top-color: #d4d4d8;
		}

		html.dark .pagination-btn:hover:not(:disabled) {
			color: #e4e4e7;
			border-top-color: #52525b;
		}

		.pagination-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.pagination-btn:focus {
			outline: none;
			border-radius: 6px;
			box-shadow: 0 0 0 2px #0ea5e9;
		}

		html.dark .pagination-btn:focus {
			box-shadow: 0 0 0 2px #0369a1;
		}

		.pagination-info {
			color: #52525b;
			font-size: 0.875rem;
			line-height: 1.25rem;
			font-weight: 500;
			padding: 8px 16px;
			border-top: 2px solid transparent;
		}

		html.dark .pagination-info {
			color: #a1a1aa;
		}

		.footer-info {
			position: absolute;
			bottom: 20px;
			right: 32px;
			display: flex;
			gap: 20px;
			font-size: 0.75rem;
			line-height: 1rem;
			color: #52525b;
			background: transparent;
		}

		html.dark .footer-info {
			color: #a1a1aa;
			background: transparent;
		}

		.loading {
			text-align: center;
			color: #52525b;
			font-size: 1rem;
			line-height: 1.5rem;
			font-weight: 500;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 100%;
			min-height: 120px;
		}

		html.dark .loading {
			color: #a1a1aa;
		}

		.error-message {
			background: #fef2f2;
			color: #be123c;
			padding: 16px 20px;
			border-radius: 8px;
			margin: 20px 32px;
			border-left: 4px solid #ef4444;
		}

		html.dark .error-message {
			background: rgba(136, 19, 55, 0.4);
			color: #fb7185;
			border-color: #fb7185;
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #52525b;
		}

		html.dark .empty-state {
			color: #a1a1aa;
		}

		.empty-state > div:last-child {
			font-weight: 600;
			margin-top: 10px;
		}

		.empty-state-icon {
			font-size: 3rem;
			line-height: 1;
			margin-bottom: 16px;
			opacity: 0.5;
		}

		/* Scrollbar styling */
		.sidebar-content::-webkit-scrollbar {
			width: 8px;
		}

		.sidebar-content::-webkit-scrollbar-track {
			background: var(--bg-secondary);
		}

		.sidebar-content::-webkit-scrollbar-thumb {
			background: var(--border-color);
			border-radius: 4px;
		}

		.sidebar-content::-webkit-scrollbar-thumb:hover {
			background: var(--text-secondary);
		}

		/* Table scrollbar - hidden by default, shown on hover (Mac-like behavior) */
		.logs-table-container > div:last-child::-webkit-scrollbar {
			width: 8px;
		}

		.logs-table-container > div:last-child::-webkit-scrollbar-track {
			background: transparent;
		}

		.logs-table-container > div:last-child::-webkit-scrollbar-thumb {
			background: transparent;
			border-radius: 4px;
		}

		.logs-table-container:hover > div:last-child::-webkit-scrollbar-thumb {
			background: var(--border-color);
		}

		.logs-table-container:hover > div:last-child::-webkit-scrollbar-thumb:hover {
			background: var(--text-secondary);
		}

		@media (max-width: 1200px) {
			.level-filters {
				width: 100%;
			}
			.search-controls {
				width: 100%;
			}
			.search-input {
				width: 100%;
			}
		}

		/* Actions dropdown styles */
		.actions-cell {
			position: relative;
			text-align: center;
			padding: 8px 4px;
		}

		.actions-btn {
			background: transparent;
			border: none;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			color: #a1a1aa;
			font-size: 1.25rem;
			line-height: 1;
			transition: background-color 0.2s ease, color 0.2s ease;
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}

		.actions-btn:hover {
			background: var(--hover-bg);
			color: var(--text-primary);
		}

		html.dark .actions-btn {
			color: #71717a;
		}

		html.dark .actions-btn:hover {
			color: #e4e4e7;
		}

		.actions-dropdown {
			position: absolute;
			right: 0;
			top: 100%;
			margin-top: 4px;
			background: white;
			border: 1px solid var(--border-color);
			border-radius: 6px;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
			min-width: 150px;
			z-index: 100;
			display: none;
			overflow: hidden;
		}

		html.dark .actions-dropdown {
			background: #27272a;
			border-color: #3f3f46;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
		}

		.actions-dropdown.show {
			display: block;
		}

		.actions-dropdown-item {
			padding: 8px 12px;
			cursor: pointer;
			transition: background-color 0.15s ease;
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 0.875rem;
			color: var(--text-primary);
		}

		.actions-dropdown-item:hover {
			background: var(--hover-bg);
		}

		.actions-dropdown-item.delete {
			color: #ef4444;
		}

		html.dark .actions-dropdown-item.delete {
			color: #fb7185;
		}

		.actions-dropdown-item.delete:hover {
			background: var(--level-error-bg);
		}
	</style>
</head>
	<body>
	<div class="main-container">
		<div class="content-wrapper">
			<div class="sidebar">
				<div class="sidebar-header">
					<div class="log-viewer-title text-xl font-semibold">Event log</div>
					<a href="/" class="back-link text-sm text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-200">← Back to Home</a>
				</div>
				<div class="sidebar-content">
					<div class="sidebar-title text-xs font-semibold uppercase tracking-wider">Sessions</div>
					<ul class="server-list list-none" id="sessionList">
						<li class="server-item active" data-session="all">
							<span class="server-name text-sm">All Sessions</span>
							<span class="server-size text-xs" id="totalSize">-</span>
						</li>
					</ul>
				</div>
			</div>

			<div class="sidebar-resizer" id="sidebarResizer" aria-hidden="true"></div>

			<div class="main-content">
				<div class="main-content-header">
					<div class="level-filters">
						<button class="level-filter-btn level-info" data-level="session_start">
							<input type="checkbox" checked id="filter-session_start" class="w-4 h-4 cursor-pointer">
							<span class="text-sm font-medium">Session</span>
							<span class="level-count text-xs font-semibold" id="count-session_start">0</span>
						</button>
						<button class="level-filter-btn level-debug" data-level="tool_call">
							<input type="checkbox" checked id="filter-tool_call" class="w-4 h-4 cursor-pointer">
							<span class="text-sm font-medium">Tool</span>
							<span class="level-count text-xs font-semibold" id="count-tool_call">0</span>
						</button>
						<button class="level-filter-btn level-warning" data-level="custom">
							<input type="checkbox" checked id="filter-custom" class="w-4 h-4 cursor-pointer">
							<span class="text-sm font-medium">Custom</span>
							<span class="level-count text-xs font-semibold" id="count-custom">0</span>
						</button>
						<button class="level-filter-btn level-error" data-level="tool_error">
							<input type="checkbox" checked id="filter-tool_error" class="w-4 h-4 cursor-pointer">
							<span class="text-sm font-medium">Error</span>
							<span class="level-count text-xs font-semibold" id="count-tool_error">0</span>
						</button>
					</div>
					<div class="search-controls">
						<input type="text" class="search-input" id="searchInput" placeholder="Search">
						<button type="button" class="icon-btn" onclick="refreshLogs(event)" title="Refresh"><i class="fa-solid fa-rotate-right"></i></button>
						<button class="icon-btn delete-all-btn" onclick="confirmDeleteAll()" title="Delete all events"><i class="fa-regular fa-trash-can"></i></button>
						<button class="icon-btn notification-toggle" onclick="toggleNotificationMode()" title="Enable notifications"><i class="fa-regular fa-bell"></i></button>
						<button class="icon-btn theme-toggle" onclick="toggleTheme()" title="Toggle theme"><i class="fa-regular fa-moon"></i></button>
					</div>
				</div>
				<div class="main-content-body">
					<div id="sessionActivityCard" class="session-activity-card hidden">
						<div class="session-activity-header">
							<div>
								<p class="label">Activity overview</p>
								<p id="sessionActivitySubtitle" class="subtitle">–</p>
							</div>
							<div id="sessionActivityLegend" class="session-activity-legend">
								<span class="legend-item">
									<span class="legend-dot" style="background: #0ea5e9;"></span>
									<span>Events per slot</span>
								</span>
								<span class="legend-item">
									<span class="legend-dot" style="background: rgba(16,185,129,0.7);"></span>
									<span>Office window</span>
								</span>
							</div>
						</div>
						<div id="sessionActivityChart"></div>
					</div>
					<div class="table-controls" id="tableControls" style="display: none;">
						<div class="table-controls-right">
							<select class="control-select" id="sortSelect">
								<option value="DESC">Newest first</option>
								<option value="ASC">Oldest first</option>
							</select>
							<select class="control-select" id="limitSelect">
								<option value="25">25 items per page</option>
								<option value="50" selected>50 items per page</option>
								<option value="100">100 items per page</option>
							</select>
						</div>
					</div>
					<div class="logs-table-container" id="logsTableContainer">
						<div id="loadingMessage" class="loading">Loading events...</div>
						<div id="errorMessage" class="error-message" style="display: none;"></div>
						<div id="emptyState" class="empty-state" style="display: none;">
							<div class="font-semibold mt-2.5">No events found</div>
						</div>
						<div style="flex: 1; overflow-y: auto; min-height: 0;">
							<table class="logs-table" id="logsTable" style="display: none;">
								<thead>
									<tr>
										<th style="width: 40px;"></th>
										<th style="width: 40px;"></th>
										<th class="time-column">Time</th>
										<th style="width: 130px;">Event</th>
										<th>Payload</th>
										<th style="width: 50px;"></th>
									</tr>
								</thead>
								<tbody id="logsBody">
								</tbody>
							</table>
						</div>
					</div>
					<div class="pagination" id="pagination" style="display: none;">
						<button class="pagination-btn" onclick="previousPage()" id="prevBtn">← Previous</button>
						<span class="pagination-info" id="pageInfo"></span>
						<button class="pagination-btn" onclick="nextPage()" id="nextBtn">Next →</button>
					</div>
					<div class="footer-info">
						<span class="text-xs">Load time: <span id="durationInfo" class="font-semibold">-</span></span>
						<span class="text-xs">Version: <span class="font-semibold">v1.0.0</span></span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
	<script>
		let currentOffset = 0;
		let limit = 50;
		let totalEvents = 0;
		let selectedSession = 'all';
		let activeFilters = new Set(['tool_call', 'session_start', 'custom', 'tool_error']);
		let searchQuery = '';
		let sortOrder = 'DESC';
		let startTime = performance.now();
		const NOTIFICATION_REFRESH_INTERVAL = 5 * 60 * 1000;
		let notificationModeEnabled = false;
		let notificationRefreshIntervalId = null;
		let lastKnownEventTimestamp = null;
		const knownSessionIds = new Set();
		let sessionActivityChart = null;
		let lastSessionActivityEvents = [];
		const SESSION_ACTIVITY_FETCH_LIMIT = 1000;
		const SESSION_ACTIVITY_SLOT_MINUTES = 10;
		const SESSION_ACTIVITY_MARGIN_MINUTES = 30;
		const SESSION_SERIES_COLORS = [
			'#53cf98',
			'#38bdf8',
			'#f97316',
			'#a78bfa',
			'#fb7185',
			'#22d3ee',
			'#c084fc',
			'#f472b6'
		];
		const OFFICE_START = { hour: 8, minute: 30 };
		const OFFICE_END = { hour: 18, minute: 30 };
		let isResizingSidebar = false;
		let sidebarResizeStartX = 0;
		let sidebarResizeStartWidth = 0;
		const globalErrorMessages = [];
		const MAX_GLOBAL_ERROR_MESSAGES = 3;

		// Theme management - using .dark class like Laravel Log Viewer
		// Detects system theme by default, but allows manual override
		function getSystemTheme() {
			return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
		}

		function applyTheme(theme) {
			if (theme === 'dark') {
				document.documentElement.classList.add('dark');
			} else {
				document.documentElement.classList.remove('dark');
			}
			updateThemeIcon(theme);
		}

		function initTheme() {
			const savedTheme = localStorage.getItem('theme');
			const theme = savedTheme || getSystemTheme();
			applyTheme(theme);
		}

		function toggleTheme() {
			const isDark = document.documentElement.classList.contains('dark');
			const newTheme = isDark ? 'light' : 'dark';
			localStorage.setItem('theme', newTheme);
			applyTheme(newTheme);
			refreshSessionActivityTheme();
		}

		function updateThemeIcon(theme) {
			const iconBtn = document.querySelector('.theme-toggle');
			if (iconBtn) {
				if (theme === 'dark') {
					iconBtn.innerHTML = '<i class="fa-regular fa-sun"></i>';
				} else {
					iconBtn.innerHTML = '<i class="fa-regular fa-moon"></i>';
				}
			}
		}

		// Listen for system theme changes and update if no manual preference is set
		if (window.matchMedia) {
			const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
			mediaQuery.addEventListener('change', (e) => {
				// Only update if user hasn't manually set a preference
				if (!localStorage.getItem('theme')) {
					const newTheme = e.matches ? 'dark' : 'light';
					applyTheme(newTheme);
					refreshSessionActivityTheme();
				}
			});
		}

		// Level filter management
		function setupLevelFilters() {
			document.querySelectorAll('.level-filter-btn').forEach(btn => {
				const checkbox = btn.querySelector('input[type="checkbox"]');
				const level = btn.dataset.level;

				function updateButtonState() {
					if (checkbox.checked) {
						btn.classList.add('active');
						activeFilters.add(level);
					} else {
						btn.classList.remove('active');
						activeFilters.delete(level);
					}
				}

				checkbox.addEventListener('change', () => {
					updateButtonState();
					currentOffset = 0;
					loadEvents();
				});

				btn.addEventListener('click', (e) => {
					if (e.target !== checkbox) {
						checkbox.checked = !checkbox.checked;
						updateButtonState();
						checkbox.dispatchEvent(new Event('change'));
					}
				});

				// Initialize button state
				updateButtonState();
			});
		}

		function setupSidebarResizer() {
			const resizer = document.getElementById('sidebarResizer');
			const sidebar = document.querySelector('.sidebar');
			if (!resizer || !sidebar) {
				return;
			}

			const startResize = (event) => {
				const point = event.touches ? event.touches[0] : event;
				isResizingSidebar = true;
				sidebarResizeStartX = point.clientX;
				sidebarResizeStartWidth = sidebar.offsetWidth;
				document.body.classList.add('sidebar-resizing');
				document.addEventListener('mousemove', handleResize);
				document.addEventListener('mouseup', stopResize);
				document.addEventListener('touchmove', handleResize, { passive: false });
				document.addEventListener('touchend', stopResize);
				event.preventDefault();
			};

			const handleResize = (event) => {
				if (!isResizingSidebar) {
					return;
				}
				const point = event.touches ? event.touches[0] : event;
				const delta = point.clientX - sidebarResizeStartX;
				let newWidth = sidebarResizeStartWidth + delta;
				newWidth = Math.max(220, Math.min(500, newWidth));
				document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
			};

			const stopResize = () => {
				if (!isResizingSidebar) {
					return;
				}
				isResizingSidebar = false;
				document.body.classList.remove('sidebar-resizing');
				document.removeEventListener('mousemove', handleResize);
				document.removeEventListener('mouseup', stopResize);
				document.removeEventListener('touchmove', handleResize);
				document.removeEventListener('touchend', stopResize);
			};

			resizer.addEventListener('mousedown', startResize);
			resizer.addEventListener('touchstart', startResize, { passive: false });
		}

		function initSessionActivityChart() {
			if (sessionActivityChart) {
				return sessionActivityChart;
			}
			const chartEl = document.getElementById('sessionActivityChart');
			if (!chartEl || typeof echarts === 'undefined') {
				return null;
			}
			sessionActivityChart = echarts.init(chartEl);
			window.addEventListener('resize', () => {
				sessionActivityChart?.resize();
			});
			return sessionActivityChart;
		}

		function hideSessionActivityCard() {
			const card = document.getElementById('sessionActivityCard');
			if (card) {
				card.classList.add('hidden');
			}
			const subtitle = document.getElementById('sessionActivitySubtitle');
			if (subtitle) {
				subtitle.textContent = '–';
			}
			lastSessionActivityEvents = [];
			if (sessionActivityChart) {
				sessionActivityChart.clear();
			}
		}

		function showSessionActivityCard() {
			const card = document.getElementById('sessionActivityCard');
			if (card) {
				card.classList.remove('hidden');
			}
		}

		async function updateSessionActivityChart(options = {}) {
			const eventsOverride = Array.isArray(options.events) ? options.events : null;
			const targetSession = typeof options.sessionId !== 'undefined' ? options.sessionId : selectedSession;

			if (eventsOverride && eventsOverride.length > 0) {
				renderSessionActivityChart(eventsOverride, { sessionId: targetSession });
				return;
			}

			if (targetSession === 'all') {
				hideSessionActivityCard();
				return;
			}

			try {
				const params = new URLSearchParams({
					sessionId: targetSession,
					orderBy: 'created_at',
					order: 'ASC',
					limit: SESSION_ACTIVITY_FETCH_LIMIT.toString()
				});
				const response = await fetch(`/api/events?${params}`);
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const data = await response.json();
				if (!data.events || data.events.length === 0) {
					hideSessionActivityCard();
					return;
				}
				renderSessionActivityChart(data.events, { sessionId: targetSession });
			} catch (error) {
				console.error('Error loading session activity chart:', error);
				hideSessionActivityCard();
			}
		}

		function renderSessionActivityChart(events, options = {}) {
			if (!Array.isArray(events) || events.length === 0) {
				hideSessionActivityCard();
				return;
			}

			const chartInstance = initSessionActivityChart();
			if (!chartInstance) {
				return;
			}

			lastSessionActivityEvents = events.slice();
			const targetSession = options.sessionId || selectedSession;
			const uniqueSessions = Array.from(new Set(events.map(evt => evt.session_id || 'Unknown session')));
			const isAllSessionsView = targetSession === 'all' && uniqueSessions.length > 0;

			let seriesData = [];
			let windowStart;
			let windowEnd;
			let referenceDate;
			let officeStart;
			let officeEnd;
			let maxBucketCount;
			let multiSeriesEntries = [];

			if (isAllSessionsView) {
				const multiSeries = buildMultiSessionActivitySeries(events);
				windowStart = multiSeries.windowStart;
				windowEnd = multiSeries.windowEnd;
				referenceDate = multiSeries.referenceDate;
				officeStart = multiSeries.officeStart;
				officeEnd = multiSeries.officeEnd;
				maxBucketCount = multiSeries.maxBucketCount;
				multiSeriesEntries = multiSeries.seriesList;
			} else {
				const singleSeries = buildSessionActivitySeries(events);
				({
					seriesData,
					windowStart,
					windowEnd,
					referenceDate,
					officeStart,
					officeEnd,
					maxBucketCount
				} = singleSeries);
			}

			const totalEvents = events.length;
			const sessionCount = uniqueSessions.length;
			const subtitle = document.getElementById('sessionActivitySubtitle');
			if (subtitle) {
				const formattedDate = formatHumanDate(referenceDate);
				const eventLabel = totalEvents === 1 ? 'event' : 'events';
				if (isAllSessionsView) {
					const sessionLabel = sessionCount === 1 ? 'session' : 'sessions';
					subtitle.textContent = `${formattedDate} · ${sessionCount} ${sessionLabel} · ${totalEvents} ${eventLabel}`;
				} else {
					subtitle.textContent = `${formattedDate} · ${totalEvents} ${eventLabel}`;
				}
			}
			showSessionActivityCard();

			const themeIsDark = document.documentElement.classList.contains('dark');
			const axisColor = themeIsDark ? '#a1a1aa' : '#52525b';
			const splitLineColor = themeIsDark ? 'rgba(63, 63, 70, 0.35)' : 'rgba(228, 228, 231, 0.35)';
			const gradientCap = 70;
			const yAxisMax = Math.max(30, maxBucketCount || 0);
			const warmOffset = Math.min(gradientCap / Math.max(yAxisMax, 1), 1);

			let chartSeries = [];
			if (isAllSessionsView) {
				chartSeries = multiSeriesEntries.map((entry, index) => {
					const color = SESSION_SERIES_COLORS[index % SESSION_SERIES_COLORS.length];
					return createMultiSessionSeriesOption(entry.sessionId, entry.seriesData, color);
				});
			} else {
				chartSeries = [createSingleSessionSeriesOption(seriesData, warmOffset)];
			}

			chartInstance.setOption({
				grid: { left: 45, right: 20, top: 15, bottom: 30 },
				xAxis: {
					type: 'time',
					min: windowStart.getTime(),
					max: windowEnd.getTime(),
					axisLabel: {
						color: axisColor,
						formatter: value => formatChartTimeLabel(new Date(value))
					},
					axisLine: { lineStyle: { color: axisColor } },
					splitLine: { show: true, lineStyle: { color: splitLineColor } },
					axisTick: { show: false }
				},
				yAxis: {
					type: 'value',
					min: 0,
					max: yAxisMax,
					minInterval: 1,
					name: 'Events',
					nameGap: 22,
					nameTextStyle: { color: axisColor },
					axisLabel: { color: axisColor },
					axisLine: { show: false },
					splitLine: { lineStyle: { color: splitLineColor } }
				},
				tooltip: {
					trigger: 'axis',
					axisPointer: { type: 'line' },
					valueFormatter: value => `${value} ${value === 1 ? 'event' : 'events'}`
				},
				series: chartSeries,
				markArea: {
					itemStyle: { color: 'rgba(16,185,129,0.12)' },
					data: [
						[
							{ xAxis: officeStart.getTime() },
							{ xAxis: officeEnd.getTime() }
						]
					]
				}
			}, true);

			chartInstance.resize();
			renderSessionActivityLegend(isAllSessionsView ? chartSeries.map(series => ({
				name: series.name,
				color: series.lineStyle?.color || '#53cf98'
			})) : null);
		}

		function buildSessionActivitySeries(events) {
			const referenceDate = new Date(events[0].timestamp);
			const eventTimes = events
				.map(event => Date.parse(event.timestamp))
				.filter(time => !Number.isNaN(time));
			const minEventTime = eventTimes.length ? Math.min(...eventTimes) : null;
			const maxEventTime = eventTimes.length ? Math.max(...eventTimes) : null;
			const { start: windowStart, end: windowEnd } = getExtendedWindow(referenceDate, minEventTime, maxEventTime);
			const officeStart = new Date(referenceDate);
			officeStart.setHours(OFFICE_START.hour, OFFICE_START.minute, 0, 0);
			const officeEnd = new Date(referenceDate);
			officeEnd.setHours(OFFICE_END.hour, OFFICE_END.minute, 0, 0);
			const slotMs = SESSION_ACTIVITY_SLOT_MINUTES * 60 * 1000;
			const slotCount = Math.floor((windowEnd.getTime() - windowStart.getTime()) / slotMs) + 1;
			const buckets = Array.from({ length: slotCount }, () => 0);

			events.forEach(event => {
				const time = Date.parse(event.timestamp);
				if (Number.isNaN(time)) {
					return;
				}
				const bucketIndex = Math.floor((time - windowStart.getTime()) / slotMs);
				if (bucketIndex >= 0 && bucketIndex < buckets.length) {
					buckets[bucketIndex] += 1;
				}
			});

			const seriesData = buckets.map((count, index) => {
				const ts = windowStart.getTime() + (index * slotMs);
				return [ts, count];
			});

			const maxBucketCount = buckets.length ? Math.max(...buckets) : 0;

			return { seriesData, windowStart, windowEnd, referenceDate, officeStart, officeEnd, maxBucketCount };
		}

		function buildMultiSessionActivitySeries(events) {
			const referenceDate = new Date(events[0].timestamp);
			const eventTimes = events
				.map(event => Date.parse(event.timestamp))
				.filter(time => !Number.isNaN(time));
			const minEventTime = eventTimes.length ? Math.min(...eventTimes) : null;
			const maxEventTime = eventTimes.length ? Math.max(...eventTimes) : null;
			const { start: windowStart, end: windowEnd } = getExtendedWindow(referenceDate, minEventTime, maxEventTime);
			const officeStart = new Date(referenceDate);
			officeStart.setHours(OFFICE_START.hour, OFFICE_START.minute, 0, 0);
			const officeEnd = new Date(referenceDate);
			officeEnd.setHours(OFFICE_END.hour, OFFICE_END.minute, 0, 0);
			const slotMs = SESSION_ACTIVITY_SLOT_MINUTES * 60 * 1000;
			const slotCount = Math.floor((windowEnd.getTime() - windowStart.getTime()) / slotMs) + 1;

			const sessionBuckets = new Map();

			events.forEach(event => {
				const time = Date.parse(event.timestamp);
				if (Number.isNaN(time)) {
					return;
				}
				const sessionId = event.session_id || 'Unknown session';
				if (!sessionBuckets.has(sessionId)) {
					sessionBuckets.set(sessionId, Array.from({ length: slotCount }, () => 0));
				}
				const bucketIndex = Math.floor((time - windowStart.getTime()) / slotMs);
				if (bucketIndex >= 0 && bucketIndex < slotCount) {
					const buckets = sessionBuckets.get(sessionId);
					buckets[bucketIndex] += 1;
				}
			});

			const seriesList = [];
			let maxBucketCount = 0;

			sessionBuckets.forEach((buckets, sessionId) => {
				const seriesData = buckets.map((count, index) => {
					const ts = windowStart.getTime() + (index * slotMs);
					return [ts, count];
				});
				maxBucketCount = Math.max(maxBucketCount, ...buckets, maxBucketCount);
				seriesList.push({
					sessionId,
					seriesData
				});
			});

			return { seriesList, windowStart, windowEnd, referenceDate, officeStart, officeEnd, maxBucketCount };
		}

		function getExtendedWindow(referenceDate, minEventTime, maxEventTime) {
			const start = new Date(referenceDate);
			start.setHours(OFFICE_START.hour, OFFICE_START.minute, 0, 0);
			start.setTime(start.getTime() - SESSION_ACTIVITY_MARGIN_MINUTES * 60 * 1000);
			if (typeof minEventTime === 'number' && minEventTime < start.getTime()) {
				start.setTime(minEventTime - SESSION_ACTIVITY_MARGIN_MINUTES * 60 * 1000);
			}
			const end = new Date(referenceDate);
			end.setHours(OFFICE_END.hour, OFFICE_END.minute, 0, 0);
			end.setTime(end.getTime() + SESSION_ACTIVITY_MARGIN_MINUTES * 60 * 1000);
			if (typeof maxEventTime === 'number' && maxEventTime > end.getTime()) {
				end.setTime(maxEventTime + SESSION_ACTIVITY_MARGIN_MINUTES * 60 * 1000);
			}
			return { start, end };
		}

		function formatChartTimeLabel(dateObj) {
			if (!(dateObj instanceof Date)) {
				return '';
			}
			return `${padNumber(dateObj.getHours())}:${padNumber(dateObj.getMinutes())}`;
		}

		function formatHumanDate(dateObj) {
			if (!(dateObj instanceof Date)) {
				return '';
			}
			const day = padNumber(dateObj.getDate());
			const month = padNumber(dateObj.getMonth() + 1);
			const year = dateObj.getFullYear();
			return `${day}/${month}/${year}`;
		}

		function padNumber(value) {
			return String(value).padStart(2, '0');
		}

		function showGlobalError(message) {
			const banner = document.getElementById('globalErrorBanner');
			if (!banner || !message) {
				return;
			}
			const formattedMessage = typeof message === 'string'
				? message
				: (message?.message || 'Unexpected error');
			globalErrorMessages.unshift(formattedMessage);
			if (globalErrorMessages.length > MAX_GLOBAL_ERROR_MESSAGES) {
				globalErrorMessages.length = MAX_GLOBAL_ERROR_MESSAGES;
			}
			banner.innerHTML = globalErrorMessages
				.map(msg => `<div>${escapeHtml(msg)}</div>`)
				.join('');
			banner.classList.remove('hidden');
		}

		function handleInitializationError(context, error) {
			const details = error?.message || error || 'Unknown error';
			console.error(`Initialization error (${context}):`, error);
			showGlobalError(`Initialization error (${context}): ${details}`);
		}

		function runSafeInitStep(label, fn) {
			try {
				if (typeof fn === 'function') {
					fn();
				}
			} catch (error) {
				handleInitializationError(label, error);
			}
		}

		function runSafeAsyncInitStep(label, fn) {
			try {
				const result = typeof fn === 'function' ? fn() : null;
				if (result && typeof result.catch === 'function') {
					result.catch(error => handleInitializationError(label, error));
				}
			} catch (error) {
				handleInitializationError(label, error);
			}
		}

		function createSingleSessionSeriesOption(seriesData, warmOffset) {
			return {
				name: 'Events',
				type: 'line',
				smooth: 0.6,
				showSymbol: false,
				lineStyle: { width: 3, color: '#53cf98' },
				areaStyle: {
					color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
						{ offset: 0, color: 'rgba(133,230,185,0.45)' },
						{ offset: warmOffset, color: 'rgba(197,241,221,0.35)' },
						{ offset: 1, color: 'rgba(216,247,232,0.16)' }
					])
				},
				data: seriesData
			};
		}

		function createMultiSessionSeriesOption(sessionId, seriesData, color) {
			const startColor = hexToRgba(color, 0.35);
			const endColor = hexToRgba(color, 0.05);
			return {
				name: formatSessionLabel(sessionId),
				type: 'line',
				smooth: 0.6,
				showSymbol: false,
				lineStyle: { width: 2.5, color },
				areaStyle: {
					color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
						{ offset: 0, color: startColor },
						{ offset: 1, color: endColor }
					])
				},
				data: seriesData
			};
		}

		function hexToRgba(hex, alpha = 1) {
			if (typeof hex !== 'string') {
				return `rgba(83, 207, 152, ${alpha})`;
			}
			let sanitized = hex.replace('#', '');
			if (sanitized.length === 3) {
				sanitized = sanitized.split('').map(ch => ch + ch).join('');
			}
			const bigint = parseInt(sanitized, 16);
			if (Number.isNaN(bigint)) {
				return `rgba(83, 207, 152, ${alpha})`;
			}
			const r = (bigint >> 16) & 255;
			const g = (bigint >> 8) & 255;
			const b = bigint & 255;
			return `rgba(${r}, ${g}, ${b}, ${alpha})`;
		}

		function formatSessionLabel(sessionId) {
			if (!sessionId) {
				return 'Unknown session';
			}
			if (sessionId.length <= 22) {
				return sessionId;
			}
			return `${sessionId.slice(0, 10)}…${sessionId.slice(-6)}`;
		}

		function escapeHtml(str) {
			return String(str ?? '')
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');
		}

		function renderSessionActivityLegend(seriesEntries) {
			const legendEl = document.getElementById('sessionActivityLegend');
			if (!legendEl) {
				return;
			}

			legendEl.innerHTML = '';

			if (Array.isArray(seriesEntries) && seriesEntries.length > 0) {
				seriesEntries.forEach(entry => {
					const safeName = escapeHtml(entry.name);
					const item = document.createElement('span');
					item.className = 'legend-item';
					item.innerHTML = `
						<span class="legend-dot" style="background: ${entry.color};"></span>
						<span>${safeName}</span>
					`;
					legendEl.appendChild(item);
				});
			} else {
				const defaultItem = document.createElement('span');
				defaultItem.className = 'legend-item';
				defaultItem.innerHTML = `
					<span class="legend-dot" style="background: #53cf98;"></span>
					<span>Events per slot</span>
				`;
				legendEl.appendChild(defaultItem);
			}

			const officeItem = document.createElement('span');
			officeItem.className = 'legend-item';
			officeItem.innerHTML = `
				<span class="legend-dot" style="background: rgba(16,185,129,0.7); border: 1px solid rgba(16,185,129,0.8);"></span>
				<span>Office window</span>
			`;
			legendEl.appendChild(officeItem);
		}

		function refreshSessionActivityTheme() {
			if (lastSessionActivityEvents.length > 0) {
				renderSessionActivityChart(lastSessionActivityEvents);
			} else if (sessionActivityChart) {
				sessionActivityChart.resize();
			}
		}

		async function loadEventTypeStats(sessionId = null) {
			try {
				const params = sessionId && sessionId !== 'all'
					? `?sessionId=${encodeURIComponent(sessionId)}`
					: '';
				const response = await fetch(`/api/event-types${params}`);
				const stats = await response.json();

				stats.forEach(stat => {
					const countEl = document.getElementById(`count-${stat.event}`);
					if (countEl) {
						countEl.textContent = stat.count || 0;
					}
				});

				// Update total size
				const total = stats.reduce((sum, stat) => sum + (stat.count || 0), 0);
				const totalSizeEl = document.getElementById('totalSize');
				if (totalSizeEl) {
					totalSizeEl.textContent = total;
				}
			} catch (error) {
				console.error('Error loading event type stats:', error);
			}
		}

		async function loadSessions() {
			try {
				const response = await fetch('/api/sessions');
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const sessions = await response.json();
				const sessionList = document.getElementById('sessionList');

				if (!sessionList) {
					console.error('sessionList element not found');
					return;
				}

				// Keep the "All Sessions" item
				const allSessionsItem = sessionList.querySelector('[data-session="all"]');
				if (!allSessionsItem) {
					console.error('All sessions item not found');
					return;
				}

				sessionList.innerHTML = '';
				sessionList.appendChild(allSessionsItem);

				// Add each session
				if (Array.isArray(sessions) && sessions.length > 0) {
					const discoveredSessionIds = [];
					sessions.forEach(session => {
						if (!session || !session.session_id) {
							console.warn('Invalid session data:', session);
							return;
						}
						discoveredSessionIds.push(session.session_id);

						const li = document.createElement('li');
						li.className = 'server-item';
						li.setAttribute('data-session', session.session_id);

						// Format session display: date and user
						let sessionDisplay = '';
						if (session.first_event) {
							const date = new Date(session.first_event);
							const day = date.getDate();
							const month = date.getMonth() + 1;
							const year = date.getFullYear().toString().slice(-2);
							const hours = String(date.getHours()).padStart(2, '0');
							const minutes = String(date.getMinutes()).padStart(2, '0');
							const dateStr = `${day}/${month}/${year} ${hours}:${minutes}`;
							const dateHtml = `<span class="session-date">${dateStr}</span>`;

							let userHtml = '';
							if (session.user_name) {
								userHtml = `<span class="session-user"> • ${session.user_name}</span>`;
							} else if (session.user_id) {
								userHtml = `<span class="session-user"> • ${session.user_id}</span>`;
							}
							sessionDisplay = `${dateHtml}${userHtml}`;
						} else {
							// Fallback to session ID if no date
							sessionDisplay = session.session_id.length > 12
								? session.session_id.substring(0, 12) + '...'
								: session.session_id;
						}

					const activeIndicator = session.is_active ? '<span class="session-active-indicator"></span>' : '';
					li.innerHTML = `
						<div style="display: flex; align-items: center; flex: 1;">
							${activeIndicator}
							<span class="server-name text-sm">${sessionDisplay}</span>
						</div>
						<span class="server-size text-xs">${session.count || 0}</span>
						<div class="server-item-actions">
							<button class="actions-btn" onclick="event.stopPropagation(); toggleSessionActionsDropdown(event, '${session.session_id}')" title="Actions">
								<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
									<circle cx="8" cy="3" r="1.5"/>
									<circle cx="8" cy="8" r="1.5"/>
									<circle cx="8" cy="13" r="1.5"/>
								</svg>
							</button>
							<div class="actions-dropdown" id="session-dropdown-${session.session_id}">
								<div class="actions-dropdown-item delete" onclick="event.stopPropagation(); confirmDeleteSession('${session.session_id}')">
									<span>🗑️</span>
									<span>Delete</span>
								</div>
							</div>
						</div>
					`;

						li.addEventListener('click', (e) => {
							// Don't activate session if clicking on actions button
							if (e.target.closest('.server-item-actions')) {
								return;
							}
							document.querySelectorAll('.server-item').forEach(i => i.classList.remove('active'));
							li.classList.add('active');
							selectedSession = session.session_id;
							// When a session is selected, default to ASC order (oldest first)
							if (selectedSession !== 'all') {
								sortOrder = 'ASC';
								document.getElementById('sortSelect').value = 'ASC';
							} else {
								sortOrder = 'DESC';
								document.getElementById('sortSelect').value = 'DESC';
							}
							currentOffset = 0;
							loadEvents();
							loadEventTypeStats(selectedSession);
						});

						sessionList.appendChild(li);
					});

					rememberSessionsFromList(discoveredSessionIds);

					// Update total size
					const total = sessions.reduce((sum, session) => sum + (session.count || 0), 0);
					const totalSizeEl = document.getElementById('totalSize');
					if (totalSizeEl) {
						totalSizeEl.textContent = total;
					}
				} else {
					// Update total size to 0 if no sessions
					const totalSizeEl = document.getElementById('totalSize');
					if (totalSizeEl) {
						totalSizeEl.textContent = '0';
					}
				}
			} catch (error) {
				console.error('Error loading sessions:', error);
				// Show error in console but don't break the UI
			}
		}

		async function loadEvents(options = {}) {
			const triggeredByNotification = Boolean(options.triggeredByNotification);
			const skipUiReset = Boolean(options.skipUiReset);
			startTime = performance.now();
			const loadingMessageEl = document.getElementById('loadingMessage');
			const logsTableEl = document.getElementById('logsTable');
			const paginationEl = document.getElementById('pagination');
			const tableControlsEl = document.getElementById('tableControls');
			const errorMessageEl = document.getElementById('errorMessage');
			const emptyStateEl = document.getElementById('emptyState');

			if (triggeredByNotification || skipUiReset) {
				if (loadingMessageEl) {
					loadingMessageEl.style.display = 'none';
				}
			} else {
				if (loadingMessageEl) {
					loadingMessageEl.style.display = 'block';
				}
				if (logsTableEl) {
					logsTableEl.style.display = 'none';
				}
				if (paginationEl) {
					paginationEl.style.display = 'none';
				}
				if (tableControlsEl) {
					tableControlsEl.style.display = 'none';
				}
			}

			if (errorMessageEl) {
				errorMessageEl.style.display = 'none';
			}
			if (emptyStateEl) {
				emptyStateEl.style.display = 'none';
			}

			try {
				const params = new URLSearchParams({
					limit: limit.toString(),
					offset: currentOffset.toString(),
					orderBy: 'created_at',
					order: sortOrder
				});

				// Apply level filters
				if (activeFilters.size > 0 && activeFilters.size < 4) {
					Array.from(activeFilters).forEach(level => {
						params.append('eventType', level);
					});
				}

				if (selectedSession !== 'all') {
					params.append('sessionId', selectedSession);
				}

				if (searchQuery) {
					params.append('search', searchQuery);
				}

				const response = await fetch(`/api/events?${params}`);
				const data = await response.json();

				const duration = Math.round(performance.now() - startTime);
				document.getElementById('durationInfo').textContent = `${duration}ms`;

				if (data.events && data.events.length > 0) {
					displayEvents(data.events);
					updatePagination(data);
					document.getElementById('logsTable').style.display = 'table';
					document.getElementById('pagination').style.display = 'flex';
					document.getElementById('tableControls').style.display = 'flex';
					handleNotificationState(data.events, triggeredByNotification);
					if (selectedSession !== 'all') {
						updateSessionActivityChart();
					} else {
						updateSessionActivityChart({ events: data.events, sessionId: 'all' });
					}
				} else {
					document.getElementById('emptyState').style.display = 'block';
					document.getElementById('tableControls').style.display = 'none';
					hideSessionActivityCard();
				}
			} catch (error) {
				console.error('Error loading events:', error);
				document.getElementById('errorMessage').textContent = 'Error loading events: ' + error.message;
				document.getElementById('errorMessage').style.display = 'block';
			} finally {
				if (loadingMessageEl) {
					loadingMessageEl.style.display = 'none';
				}
			}
		}

		function normalizeEventData(rawData) {
			if (!rawData) {
				return {};
			}
			if (typeof rawData === 'object') {
				return rawData;
			}
			try {
				return JSON.parse(rawData);
			} catch (_error) {
				return {};
			}
		}

		function displayEvents(events) {
			const tbody = document.getElementById('logsBody');
			tbody.innerHTML = '';

			events.forEach(event => {
				const levelClass = getLevelClass(event.event);
				const description = formatDescription(event);
				const descriptionPretty = formatDescriptionPretty(event);
				const eventData = normalizeEventData(event.data);
				const dataStatus = typeof eventData.status === 'string'
					? eventData.status.toLowerCase()
					: null;
				const isToolFailure = event.event === 'tool_call' && (
					dataStatus === 'error' ||
					dataStatus === 'failed' ||
					eventData.success === false ||
					Boolean(eventData.error)
				);
				const isError = event.event === 'tool_error' || event.event === 'error' || isToolFailure;
				const statusClass = isError ? 'ko' : 'ok';
				const statusLabel = isError ? 'KO' : 'OK';

				// Main row
				const row = document.createElement('tr');
				row.className = `log-item-${levelClass}`;
				row.setAttribute('data-event-id', event.id);
				row.innerHTML = `
					<td style="text-align: center; padding: 2px 8px;">
						<button class="expand-btn" type="button" id="expand-btn-${event.id}" title="Expand/Collapse">
							<i class="fa-solid fa-chevron-right"></i>
						</button>
					</td>
					<td style="text-align: center; padding: 2px 8px;">
						<span class="status-indicator ${statusClass}" title="${isError ? 'Error' : 'OK'}">${statusLabel}</span>
					</td>
					<td class="log-time">${formatDate(event.timestamp)}</td>
					<td>
						<span class="level-badge ${levelClass}">
							${event.event.replace('_', ' ')}
						</span>
					</td>
					<td class="log-description">${description}</td>
					<td class="actions-cell">
						<button class="actions-btn" onclick="toggleActionsDropdown(event, ${event.id})" title="Actions">
							<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
								<circle cx="8" cy="3" r="1.5"/>
								<circle cx="8" cy="8" r="1.5"/>
								<circle cx="8" cy="13" r="1.5"/>
							</svg>
						</button>
						<div class="actions-dropdown" id="dropdown-${event.id}">
							<div class="actions-dropdown-item delete" onclick="confirmDeleteEvent(${event.id})">
								<span>🗑️</span>
								<span>Delete</span>
							</div>
						</div>
					</td>
				`;
				const expandButton = row.querySelector(`#expand-btn-${event.id}`);
				if (expandButton) {
					expandButton.addEventListener('click', (evt) => {
						evt.stopPropagation();
						toggleRowExpand(event.id);
					});
				}

				row.addEventListener('click', (evt) => {
					if (evt.target.closest('.actions-btn') || evt.target.closest('.actions-dropdown')) {
						return;
					}

					toggleRowExpand(event.id);
				});

				tbody.appendChild(row);

				// Expanded row
				const expandedRow = document.createElement('tr');
				expandedRow.className = `log-item-expanded log-item-${levelClass}`;
				expandedRow.id = `expanded-${event.id}`;

				const expandedTd = document.createElement('td');
				expandedTd.colSpan = 5;
				expandedTd.className = 'log-description-expanded';

				const pre = document.createElement('pre');
				pre.className = 'json-pretty';
				pre.textContent = descriptionPretty;

				expandedTd.appendChild(pre);
				expandedRow.appendChild(document.createElement('td')); // Empty first cell
				expandedRow.appendChild(expandedTd);
				tbody.appendChild(expandedRow);
			});
		}

		function getLevelClass(eventType) {
			const levelMap = {
				'tool_call': 'debug',
				'session_start': 'info',
				'session_end': 'info',
				'tool_error': 'error',
				'error': 'error',
				'custom': 'warning'
			};
			return levelMap[eventType] || 'info';
		}

		function getLevelIcon(eventType) {
			const iconMap = {
				'tool_call': '🐛',
				'session_start': 'ℹ️',
				'session_end': 'ℹ️',
				'tool_error': '❌',
				'error': '❌',
				'custom': '⚠️'
			};
			return iconMap[eventType] || 'ℹ️';
		}

		function formatDescription(event) {
			// Reconstruct the full payload as it was received
			const payload = {
				event: event.event,
				timestamp: event.timestamp,
				serverId: event.server_id || null,
				version: event.version || null,
				sessionId: event.session_id || null,
				userId: event.user_id || null,
				data: event.data || {}
			};

			// Remove null values to keep the JSON clean
			Object.keys(payload).forEach(key => {
				if (payload[key] === null) {
					delete payload[key];
				}
			});

			// Return as single line JSON (no indentation)
			return JSON.stringify(payload);
		}

		function formatDescriptionPretty(event) {
			// Reconstruct the full payload as it was received
			const payload = {
				event: event.event,
				timestamp: event.timestamp,
				serverId: event.server_id || null,
				version: event.version || null,
				sessionId: event.session_id || null,
				userId: event.user_id || null,
				data: event.data || {}
			};

			// Remove null values to keep the JSON clean
			Object.keys(payload).forEach(key => {
				if (payload[key] === null) {
					delete payload[key];
				}
			});

			// Return as pretty formatted JSON (with indentation)
			return JSON.stringify(payload, null, 2);
		}

		function toggleRowExpand(eventId) {
			const expandedRow = document.getElementById(`expanded-${eventId}`);
			const mainRow = document.querySelector(`tr[data-event-id="${eventId}"]`);
			const expandBtn = document.getElementById(`expand-btn-${eventId}`);

			if (expandedRow.classList.contains('expanded')) {
				// Collapse
				expandedRow.classList.remove('expanded');
				expandBtn.classList.remove('expanded');
				mainRow.classList.remove('expanded');
			} else {
				// Expand
				expandedRow.classList.add('expanded');
				expandBtn.classList.add('expanded');
				mainRow.classList.add('expanded');
			}
		}

		function formatDate(dateString) {
			if (!dateString) return '-';
			const date = new Date(dateString);
			const day = date.getDate();
			const month = date.getMonth() + 1;
			const year = date.getFullYear().toString().slice(-2);
			const hours = String(date.getHours()).padStart(2, '0');
			const minutes = String(date.getMinutes()).padStart(2, '0');
			return `${day}/${month}/${year} ${hours}:${minutes}`;
		}

		function formatSize(bytes) {
			if (bytes < 1024) return bytes + ' B';
			if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
			return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
		}

		function updatePagination(data) {
			const pageInfo = document.getElementById('pageInfo');
			const currentPage = Math.floor(data.offset / data.limit) + 1;
			const totalPages = Math.ceil(data.total / data.limit);
			pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${data.total} total)`;

			document.getElementById('prevBtn').disabled = currentOffset === 0;
			document.getElementById('nextBtn').disabled = !data.hasMore;
		}

		function previousPage() {
			if (currentOffset >= limit) {
				currentOffset -= limit;
				loadEvents();
			}
		}

		function nextPage() {
			currentOffset += limit;
			loadEvents();
		}

		function refreshLogs(event) {
			if (event?.preventDefault) {
				event.preventDefault();
			}
			currentOffset = 0;
			loadEventTypeStats(selectedSession);
			loadSessions();
			loadEvents({ skipUiReset: true });
		}

		let deleteAllConfirmed = false;

		function confirmDeleteAll() {
			if (!deleteAllConfirmed) {
				deleteAllConfirmed = true;
				const confirmed = confirm('Are you sure you want to delete ALL events? This action cannot be undone.\n\nClick OK to confirm, or Cancel to abort.');
				if (!confirmed) {
					deleteAllConfirmed = false;
					return;
				}
				// Second confirmation
				const secondConfirmed = confirm('FINAL WARNING: This will permanently delete ALL events from the database.\n\nAre you absolutely sure?');
				if (!secondConfirmed) {
					deleteAllConfirmed = false;
					return;
				}
			}

			// Perform deletion
			deleteAllEvents();
		}

		async function deleteAllEvents() {
			try {
				const response = await fetch('/api/events', {
					method: 'DELETE'
				});

				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}

				const data = await response.json();
				alert(`Successfully deleted ${data.deletedCount || 0} events.`);

				// Reset confirmation flag
				deleteAllConfirmed = false;

				// Refresh the view
				currentOffset = 0;
				loadEventTypeStats(selectedSession);
				loadSessions();
				loadEvents();
			} catch (error) {
				console.error('Error deleting events:', error);
				alert('Error deleting events: ' + error.message);
				deleteAllConfirmed = false;
			}
		}

		function toggleNotificationMode() {
			if (notificationModeEnabled) {
				disableNotificationMode();
			} else {
				enableNotificationMode();
			}
		}

		async function enableNotificationMode() {
			if (!('Notification' in window)) {
				alert('Your browser does not support desktop notifications.');
				return;
			}

			let permission = Notification.permission;
			if (permission === 'default') {
				try {
					permission = await Notification.requestPermission();
				} catch (error) {
					console.error('Notification permission error:', error);
					permission = 'denied';
				}
			}

			if (permission !== 'granted') {
				alert('You must allow browser notifications to enable this mode.');
				return;
			}

			notificationModeEnabled = true;
			updateNotificationButtonState();
			scheduleNotificationRefresh();
		}

		function disableNotificationMode() {
			notificationModeEnabled = false;
			updateNotificationButtonState();
			clearNotificationInterval();
		}

		function updateNotificationButtonState() {
			const button = document.querySelector('.notification-toggle');
			if (!button) {
				return;
			}
			button.classList.toggle('active', notificationModeEnabled);
			button.setAttribute('title', notificationModeEnabled ? 'Disable notifications' : 'Enable notifications');
			button.innerHTML = notificationModeEnabled
				? '<i class="fa-solid fa-bell"></i>'
				: '<i class="fa-regular fa-bell"></i>';
		}

		function scheduleNotificationRefresh() {
			clearNotificationInterval();
			notificationRefreshIntervalId = setInterval(() => {
				loadEvents({ triggeredByNotification: true });
			}, NOTIFICATION_REFRESH_INTERVAL);
			loadEvents({ triggeredByNotification: true });
		}

		function clearNotificationInterval() {
			if (notificationRefreshIntervalId) {
				clearInterval(notificationRefreshIntervalId);
				notificationRefreshIntervalId = null;
			}
		}

		function handleNotificationState(events, triggeredByNotification) {
			if (!Array.isArray(events) || events.length === 0) {
				return;
			}

			const newestTimestamp = getNewestTimestampFromEvents(events);

			if (notificationModeEnabled && triggeredByNotification && lastKnownEventTimestamp) {
				const newSessionIds = events.reduce((set, event) => {
					const eventTimestamp = getEventTimestamp(event);
					const sessionId = event?.session_id;
					if (
						eventTimestamp !== null &&
						eventTimestamp > lastKnownEventTimestamp &&
						sessionId &&
						!knownSessionIds.has(sessionId)
					) {
						set.add(sessionId);
					}
					return set;
				}, new Set());

				if (newSessionIds.size > 0) {
					notifyAboutNewSessions(newSessionIds.size);
					newSessionIds.forEach((sessionId) => knownSessionIds.add(sessionId));
				}
			}

			rememberSessionsFromEvents(events);

			if (newestTimestamp !== null) {
				lastKnownEventTimestamp = Math.max(lastKnownEventTimestamp || 0, newestTimestamp);
			}
		}

		function getNewestTimestampFromEvents(events) {
			return events.reduce((latest, event) => {
				const eventTimestamp = getEventTimestamp(event);
				if (eventTimestamp === null) {
					return latest;
				}
				if (latest === null || eventTimestamp > latest) {
					return eventTimestamp;
				}
				return latest;
			}, lastKnownEventTimestamp);
		}

		function getEventTimestamp(event) {
			if (!event || !event.timestamp) {
				return null;
			}
			const timestamp = Date.parse(event.timestamp);
			return Number.isNaN(timestamp) ? null : timestamp;
		}

		function rememberSessionId(sessionId) {
			if (typeof sessionId === 'string' && sessionId.trim() !== '') {
				knownSessionIds.add(sessionId);
			}
		}

		function rememberSessionsFromList(sessionIds) {
			if (!Array.isArray(sessionIds)) {
				return;
			}
			sessionIds.forEach(rememberSessionId);
		}

		function rememberSessionsFromEvents(events) {
			if (!Array.isArray(events)) {
				return;
			}
			events.forEach(event => {
				if (event?.session_id) {
					rememberSessionId(event.session_id);
				}
			});
		}

		function notifyAboutNewSessions(newSessionsCount) {
			if (!('Notification' in window) || Notification.permission !== 'granted' || newSessionsCount <= 0) {
				return;
			}

			const title = 'New telemetry sessions';
			const body = newSessionsCount === 1
				? '1 new session started.'
				: `${newSessionsCount} new sessions started.`;

			try {
				new Notification(title, {
					body,
					tag: 'telemetry-sessions',
					renotify: true
				});
			} catch (error) {
				console.error('Error showing notification:', error);
			}
		}

		// Search with debounce
		let searchDebounceTimer;
		const searchInputEl = document.getElementById('searchInput');
		if (searchInputEl) {
			searchInputEl.addEventListener('input', (e) => {
				clearTimeout(searchDebounceTimer);
				searchDebounceTimer = setTimeout(() => {
					searchQuery = e.target.value;
					currentOffset = 0;
					loadEvents();
				}, 500);
			});
		} else {
			handleInitializationError('search input binding', new Error('Search input not found'));
		}

		// Sort order change
		const sortSelectEl = document.getElementById('sortSelect');
		if (sortSelectEl) {
			sortSelectEl.addEventListener('change', (e) => {
				sortOrder = e.target.value;
				currentOffset = 0;
				loadEvents();
			});
		} else {
			handleInitializationError('sort select binding', new Error('Sort select not found'));
		}

		// Limit change
		const limitSelectEl = document.getElementById('limitSelect');
		if (limitSelectEl) {
			limitSelectEl.addEventListener('change', (e) => {
				limit = parseInt(e.target.value);
				currentOffset = 0;
				loadEvents();
			});
		} else {
			handleInitializationError('limit select binding', new Error('Items-per-page select not found'));
		}

		// Session selection (for "All Sessions" item)
		document.querySelectorAll('[data-session="all"]').forEach(item => {
			item.addEventListener('click', () => {
				document.querySelectorAll('.server-item').forEach(i => i.classList.remove('active'));
				item.classList.add('active');
				selectedSession = 'all';
				sortOrder = 'DESC';
				document.getElementById('sortSelect').value = 'DESC';
				currentOffset = 0;
				loadEvents();
				loadEventTypeStats(selectedSession);
			});
		});

		// Close dropdowns when clicking outside
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.actions-cell') && !e.target.closest('.server-item-actions')) {
				document.querySelectorAll('.actions-dropdown').forEach(dropdown => {
					dropdown.classList.remove('show');
				});
				document.querySelectorAll('.server-item').forEach(item => {
					item.classList.remove('dropdown-open');
				});
			}
		});

		function toggleActionsDropdown(e, eventId) {
			e.stopPropagation();
			const dropdown = document.getElementById(`dropdown-${eventId}`);
			const isShowing = dropdown.classList.contains('show');

			// Close all other dropdowns
			document.querySelectorAll('.actions-dropdown').forEach(d => {
				d.classList.remove('show');
			});

			// Toggle this dropdown
			if (!isShowing) {
				dropdown.classList.add('show');
			}
		}

		function toggleSessionActionsDropdown(e, sessionId) {
			e.stopPropagation();
			const dropdown = document.getElementById(`session-dropdown-${sessionId}`);
			const isShowing = dropdown.classList.contains('show');
			const serverItem = dropdown.closest('.server-item');

			// Close all other dropdowns and remove their classes
			document.querySelectorAll('.actions-dropdown').forEach(d => {
				d.classList.remove('show');
			});
			document.querySelectorAll('.server-item').forEach(item => {
				item.classList.remove('dropdown-open');
			});

			// Toggle this dropdown
			if (!isShowing) {
				dropdown.classList.add('show');
				if (serverItem) {
					serverItem.classList.add('dropdown-open');
				}
			}
		}

		function confirmDeleteEvent(eventId) {
			const confirmed = confirm('Are you sure you want to delete this event? This action cannot be undone.');
			if (confirmed) {
				deleteEvent(eventId);
			}
		}

		async function deleteEvent(eventId) {
			try {
				const response = await fetch(`/api/events/${eventId}`, {
					method: 'DELETE'
				});

				if (!response.ok) {
					const data = await response.json();
					throw new Error(data.message || `HTTP error! status: ${response.status}`);
				}

				// Close dropdown
				document.querySelectorAll('.actions-dropdown').forEach(d => {
					d.classList.remove('show');
				});

				// Refresh the view
				loadEventTypeStats(selectedSession);
				loadSessions();
				loadEvents();
			} catch (error) {
				console.error('Error deleting event:', error);
				alert('Error deleting the event: ' + error.message);
			}
		}

		function confirmDeleteSession(sessionId) {
			const confirmed = confirm('Are you sure you want to delete all events from this session? This action cannot be undone.');
			if (confirmed) {
				deleteSession(sessionId);
			}
		}

		async function deleteSession(sessionId) {
			try {
				const response = await fetch(`/api/events?sessionId=${encodeURIComponent(sessionId)}`, {
					method: 'DELETE'
				});

				if (!response.ok) {
					const data = await response.json();
					throw new Error(data.message || `HTTP error! status: ${response.status}`);
				}

				const data = await response.json();

				// Close dropdown
				document.querySelectorAll('.actions-dropdown').forEach(d => {
					d.classList.remove('show');
				});
				document.querySelectorAll('.server-item').forEach(item => {
					item.classList.remove('dropdown-open');
				});

				// If we were viewing this session, switch to "all"
				if (selectedSession === sessionId) {
					selectedSession = 'all';
					document.querySelectorAll('.server-item').forEach(i => i.classList.remove('active'));
					const allSessionsItem = document.querySelector('[data-session="all"]');
					if (allSessionsItem) {
						allSessionsItem.classList.add('active');
					}
					sortOrder = 'DESC';
					document.getElementById('sortSelect').value = 'DESC';
				}

				// Refresh the view
				loadEventTypeStats(selectedSession);
				loadSessions();
				loadEvents();
			} catch (error) {
				console.error('Error deleting session:', error);
				alert('Error deleting the session: ' + error.message);
			}
		}

		window.addEventListener('error', (event) => {
			if (!event) {
				return;
			}
			const message = event.message || 'Unexpected runtime error';
			showGlobalError(`Runtime error: ${message}`);
		});

		window.addEventListener('unhandledrejection', (event) => {
			if (!event) {
				return;
			}
			const reason = event.reason?.message || event.reason || 'Unhandled promise rejection';
			showGlobalError(`Unhandled error: ${reason}`);
		});

		function initializeApp() {
			runSafeInitStep('notification button state', updateNotificationButtonState);
			runSafeInitStep('theme initialization', initTheme);
			runSafeInitStep('level filters setup', setupLevelFilters);
			runSafeInitStep('sidebar resizer setup', setupSidebarResizer);
			runSafeAsyncInitStep('event type stats', () => loadEventTypeStats(selectedSession));
			runSafeAsyncInitStep('sessions list', () => loadSessions());
			runSafeAsyncInitStep('events table', () => loadEvents());
		}

		initializeApp();
	</script>
</body>
</html>
